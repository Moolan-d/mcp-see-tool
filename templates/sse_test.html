<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP React Code Generator - SSE æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress {
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            background: #28a745;
            height: 30px;
            line-height: 30px;
            text-align: center;
            color: white;
            transition: width 0.3s ease;
            width: 0%;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
        }
        .log-start { background: #d4edda; }
        .log-progress { background: #fff3cd; }
        .log-result { background: #d1ecf1; }
        .log-error { background: #f8d7da; }
        .log-end { background: #e2e3e5; }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ MCP React Code Generator - SSE æµ‹è¯•</h1>
        
        <div class="form-group">
            <label for="mcpData">MCP JSON æ•°æ®:</label>
            <textarea id="mcpData" rows="10" placeholder='è¯·è¾“å…¥ MCP JSON æ•°æ®ï¼Œä¾‹å¦‚:
{
  "model": {
    "name": "MyComponent",
    "style": {
      "width": 300,
      "height": 200,
      "backgroundColor": "#f0f8ff"
    }
  },
  "control": {
    "props": {
      "hasAvatar": true
    }
  },
  "prompt": "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·å¡ç‰‡ç»„ä»¶"
}'>{
  "model": {
    "name": "UserCard",
    "style": {
      "width": 300,
      "height": 200,
      "backgroundColor": "#f0f8ff"
    }
  },
  "control": {
    "props": {
      "hasAvatar": true
    }
  },
  "prompt": "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·å¡ç‰‡ç»„ä»¶"
}</textarea>
        </div>

        <button onclick="generateCode(false)">ğŸ“ æ™®é€šç”Ÿæˆ</button>
        <button onclick="generateCode(true)" id="streamBtn">ğŸŒŠ æµå¼ç”Ÿæˆ (SSE)</button>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <div class="log" id="log" style="display: none;"></div>

        <div class="result" id="result" style="display: none;"></div>
    </div>

    <script>
        let eventSource = null;

        function generateCode(useStream) {
            const mcpData = document.getElementById('mcpData').value;
            const logEl = document.getElementById('log');
            const resultEl = document.getElementById('result');
            const progressEl = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const streamBtn = document.getElementById('streamBtn');

            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            logEl.innerHTML = '';
            resultEl.innerHTML = '';
            resultEl.style.display = 'none';
            
            let mcp_json;
            try {
                mcp_json = JSON.parse(mcpData);
            } catch (e) {
                alert('JSON æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            if (useStream) {
                // ä½¿ç”¨ SSE æµå¼ç”Ÿæˆ
                logEl.style.display = 'block';
                progressEl.style.display = 'block';
                streamBtn.disabled = true;
                
                // å…³é—­ä¹‹å‰çš„è¿æ¥
                if (eventSource) {
                    eventSource.close();
                }

                eventSource = new EventSource('/invoke/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mcp_json: mcp_json,
                        stream: true
                    })
                });

                // ä½¿ç”¨ fetch å‘é€ POST è¯·æ±‚å¹¶å¤„ç† SSE
                fetch('/invoke/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mcp_json: mcp_json,
                        stream: true
                    })
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    function processText({ done, value }) {
                        if (done) {
                            streamBtn.disabled = false;
                            return;
                        }

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    handleSSEMessage(data);
                                } catch (e) {
                                    console.error('è§£æ SSE æ•°æ®é”™è¯¯:', e);
                                }
                            }
                        }

                        return reader.read().then(processText);
                    }

                    return reader.read().then(processText);
                }).catch(error => {
                    console.error('SSE è¯·æ±‚é”™è¯¯:', error);
                    streamBtn.disabled = false;
                });

            } else {
                // ä½¿ç”¨æ™®é€š API
                progressEl.style.display = 'none';
                logEl.style.display = 'none';
                
                fetch('/invoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mcp_json: mcp_json
                    })
                })
                .then(response => response.json())
                .then(data => {
                    resultEl.innerHTML = data.output;
                    resultEl.style.display = 'block';
                })
                .catch(error => {
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                    alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
                });
            }
        }

        function handleSSEMessage(data) {
            const logEl = document.getElementById('log');
            const resultEl = document.getElementById('result');
            const progressBar = document.getElementById('progressBar');
            const streamBtn = document.getElementById('streamBtn');

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${data.type}`;
            
            switch (data.type) {
                case 'start':
                    logEntry.textContent = `ğŸš€ ${data.message}`;
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    break;
                    
                case 'progress':
                    logEntry.textContent = `â³ ${data.message} (${data.progress.toFixed(1)}%)`;
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress.toFixed(1) + '%';
                    break;
                    
                case 'result':
                    logEntry.textContent = 'âœ… ä»£ç ç”Ÿæˆå®Œæˆ!';
                    resultEl.innerHTML = data.output;
                    resultEl.style.display = 'block';
                    break;
                    
                case 'end':
                    logEntry.textContent = 'ğŸ‰ æµå¼ä¼ è¾“ç»“æŸ';
                    streamBtn.disabled = false;
                    break;
                    
                case 'error':
                    logEntry.textContent = `âŒ é”™è¯¯: ${data.error}`;
                    streamBtn.disabled = false;
                    break;
            }
            
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­ SSE è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html> 